# Интеграция с Microsoft Active Directory

## Обзор

Система ЦУМ: Корпоративный университет поддерживает полную интеграцию с Microsoft Active Directory для обеспечения единой точки входа и централизованного управления пользователями.

## Поддерживаемые протоколы

### LDAP
- Аутентификация пользователей
- Получение информации о пользователях
- Синхронизация организационной структуры

### SAML 2.0
- Single Sign-On (SSO)
- Автоматический вход для авторизованных в домене пользователей
- Поддержка Identity Provider (IdP) initiated и Service Provider (SP) initiated flows

## Настройка интеграции

### Шаг 1: Настройка LDAP подключения

1. Перейдите в **Настройки → Аутентификация → LDAP**
2. Укажите параметры подключения:
   - **LDAP сервер**: `ldap://dc.company.local` или `ldaps://dc.company.local:636`
   - **Base DN**: `DC=company,DC=local`
   - **Bind DN**: `CN=lms_service,CN=Users,DC=company,DC=local`
   - **Bind пароль**: пароль сервисной учетной записи

3. Настройте маппинг атрибутов:
   ```
   username -> sAMAccountName
   email -> mail
   firstName -> givenName
   lastName -> sn
   displayName -> displayName
   department -> department
   manager -> manager
   ```

4. Проверьте подключение кнопкой "Тест соединения"

### Шаг 2: Настройка SAML SSO

1. Перейдите в **Настройки → Аутентификация → SAML**
2. Скачайте метаданные Service Provider
3. Настройте в AD FS или другом Identity Provider:
   - Загрузите SP метаданные
   - Настройте claim rules для передачи атрибутов
   - Получите IdP метаданные

4. Загрузите IdP метаданные в систему ЦУМ
5. Включите опцию "Автоматическое создание пользователей"

### Шаг 3: Синхронизация пользователей

1. Настройте фильтры для синхронизации:
   - **LDAP фильтр**: `(&(objectClass=user)(objectCategory=person)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))`
   - **OU для синхронизации**: выберите нужные Organizational Units

2. Настройте расписание синхронизации:
   - Полная синхронизация: ежедневно в 02:00
   - Инкрементальная: каждые 4 часа

## Безопасность

### Требования к сервисной учетной записи
- Минимальные права: чтение атрибутов пользователей и групп
- Рекомендуется создать отдельную учетную запись для LMS
- Пароль должен быть настроен на "не истекает"

### Шифрование
- Используйте LDAPS (LDAP over SSL) для защиты credentials
- Для SAML обязательно использование HTTPS
- Сертификаты должны быть от доверенного CA

### Аудит
- Все попытки входа логируются
- Неудачные попытки аутентификации записываются с IP адресом
- Изменения в настройках интеграции требуют прав администратора

## Troubleshooting

### Пользователь не может войти
1. Проверьте, активна ли учетная запись в AD
2. Убедитесь, что пользователь входит в синхронизируемые OU
3. Проверьте логи LDAP на предмет ошибок bind

### SSO не работает
1. Проверьте, что время на серверах синхронизировано (NTP)
2. Убедитесь, что сертификаты не истекли
3. Проверьте, что assertion содержит все необходимые атрибуты

### Медленная аутентификация
1. Проверьте сетевую связность с контроллерами домена
2. Оптимизируйте LDAP фильтры
3. Включите кеширование результатов (настройки → производительность)

## FAQ

**Q: Можно ли использовать несколько доменов AD?**
A: Да, система поддерживает федерацию нескольких доменов через trust relationships.

**Q: Что происходит при увольнении сотрудника?**
A: При следующей синхронизации учетная запись в LMS будет деактивирована, но данные сохранятся.

**Q: Поддерживается ли Azure AD?**
A: Да, через SAML 2.0 протокол. LDAP синхронизация требует Azure AD Domain Services.

**Q: Как часто обновляются данные пользователей?**
A: При каждом входе + по расписанию синхронизации (настраивается). 