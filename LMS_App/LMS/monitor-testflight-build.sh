#!/bin/bash

echo "=== –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–±–æ—Ä–∫–∏ TestFlight ==="
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
show_progress() {
    local current=$1
    local total=$2
    local percent=$((current * 100 / total))
    local filled=$((percent / 5))
    
    printf "\r["
    printf "%${filled}s" | tr ' ' '='
    printf "%$((20 - filled))s" | tr ' ' ' '
    printf "] ${percent}%% "
}

echo -e "${BLUE}üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–±–æ—Ä–∫–∏...${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
if pgrep -f "fastlane beta" > /dev/null; then
    echo -e "${GREEN}‚úì –ü—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∫–∏ –∞–∫—Ç–∏–≤–µ–Ω${NC}"
    echo ""
    
    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
    LOG_FILE="/tmp/fastlane_build.log"
    if [ -f "$LOG_FILE" ]; then
        echo -e "${YELLOW}üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –ª–æ–≥–∞:${NC}"
        tail -10 "$LOG_FILE"
    fi
    
    echo ""
    echo -e "${YELLOW}‚è≥ –≠—Ç–∞–ø—ã —Å–±–æ—Ä–∫–∏ TestFlight:${NC}"
    echo ""
    
    # –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å –ª–æ–≥–∏)
    steps=(
        "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ git —Å—Ç–∞—Ç—É—Å–∞"
        "2. –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Å–±–æ—Ä–∫–∏ –∏–∑ TestFlight"
        "3. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –Ω–æ–º–µ—Ä–∞ —Å–±–æ—Ä–∫–∏"
        "4. –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
        "5. –°–æ–∑–¥–∞–Ω–∏–µ .ipa —Ñ–∞–π–ª–∞"
        "6. –ó–∞–≥—Ä—É–∑–∫–∞ –≤ TestFlight"
        "7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Apple"
        "8. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ"
    )
    
    for i in "${!steps[@]}"; do
        echo -e "${BLUE}${steps[$i]}${NC}"
        if [ $i -lt 3 ]; then
            echo -e "  ${GREEN}‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ${NC}"
        elif [ $i -eq 3 ]; then
            echo -e "  ${YELLOW}‚ö° –í –ø—Ä–æ—Ü–µ—Å—Å–µ...${NC}"
            show_progress 45 100
            echo ""
        else
            echo -e "  ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ"
        fi
    done
    
    echo ""
    echo -e "${YELLOW}üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:${NC}"
    echo "‚Ä¢ –°–±–æ—Ä–∫–∞ –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç 5-10 –º–∏–Ω—É—Ç"
    echo "‚Ä¢ –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ Apple –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–∏–ª–¥ 10-15 –º–∏–Ω—É—Ç"
    echo "‚Ä¢ –í—ã –ø–æ–ª—É—á–∏—Ç–µ email –∫–æ–≥–¥–∞ –±–∏–ª–¥ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é"
    
else
    echo -e "${RED}‚úó –ü—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "‚Ä¢ –°–±–æ—Ä–∫–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    echo "‚Ä¢ –ü—Ä–æ—Ü–µ—Å—Å –±—ã–ª –ø—Ä–µ—Ä–≤–∞–Ω"
    echo "‚Ä¢ –°–±–æ—Ä–∫–∞ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    if [ -d "./build" ] && [ -f "./build/LMS.ipa" ]; then
        echo ""
        echo -e "${GREEN}‚úì –ù–∞–π–¥–µ–Ω –≥–æ—Ç–æ–≤—ã–π .ipa —Ñ–∞–π–ª:${NC}"
        ls -lh ./build/LMS.ipa
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è
        if [ "$(find ./build/LMS.ipa -mmin -30)" ]; then
            echo -e "${GREEN}‚úì –§–∞–π–ª —Å–æ–∑–¥–∞–Ω –Ω–µ–¥–∞–≤–Ω–æ (< 30 –º–∏–Ω—É—Ç)${NC}"
            echo -e "${GREEN}‚úì –í–µ—Ä–æ—è—Ç–Ω–æ, —Å–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
        fi
    fi
fi

echo ""
echo "=== –°—Ç–∞—Ç—É—Å TestFlight ==="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤
echo -e "${BLUE}üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:${NC}"
git log --oneline -5

echo ""
echo -e "${YELLOW}üîÑ –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞${NC}" 