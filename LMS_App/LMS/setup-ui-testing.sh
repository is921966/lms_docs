#!/bin/bash

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ UI —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "LMS.xcodeproj/project.pbxproj" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ LMS_App/LMS/"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º git hook –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f "../../.git/hooks/pre-commit" ]; then
    echo "üìù –°–æ–∑–¥–∞—é pre-commit hook..."
    
    cat > ../../.git/hooks/pre-commit << 'EOF'
#!/bin/bash

# Pre-commit hook –¥–ª—è –∑–∞–ø—É—Å–∫–∞ UI —Ç–µ—Å—Ç–æ–≤
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∫–æ–º–º–∏—Ç–æ–º

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ iOS —Ñ–∞–π–ª–∞—Ö
if git diff --cached --name-only | grep -E 'LMS_App/.*\.(swift|xib|storyboard)$' > /dev/null; then
    echo "üß™ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ iOS —Ñ–∞–π–ª–∞—Ö. –ó–∞–ø—É—Å–∫–∞—é UI —Ç–µ—Å—Ç—ã..."
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    cd LMS_App/LMS || exit 1
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
    echo "‚è±Ô∏è  –ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏..."
    
    # –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ (–±–µ–∑ –∑–∞–ø—É—Å–∫–∞) –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    if xcodebuild build-for-testing \
        -scheme LMS \
        -destination 'platform=iOS Simulator,name=iPhone 16' \
        -quiet; then
        echo "‚úÖ –ö–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ!"
        
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–ø—É—Å–∫–∞–µ–º –æ–¥–∏–Ω –±—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
        echo "üöÄ –ó–∞–ø—É—Å–∫ smoke —Ç–µ—Å—Ç–∞..."
        if xcodebuild test \
            -scheme LMS \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            -only-testing:LMSUITests/LMSUITests/testMockLogin_AsStudent_ShouldSucceed \
            -quiet; then
            echo "‚úÖ Smoke —Ç–µ—Å—Ç –ø—Ä–æ—à–µ–ª!"
        else
            echo "‚ùå Smoke —Ç–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è!"
            echo "üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ ./test-ui.sh –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞ —Ç–µ—Å—Ç–æ–≤"
            exit 1
        fi
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏!"
        exit 1
    fi
fi

exit 0
EOF
    
    chmod +x ../../.git/hooks/pre-commit
    echo "‚úÖ Pre-commit hook —Å–æ–∑–¥–∞–Ω!"
else
    echo "‚ÑπÔ∏è  Pre-commit hook —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –°–æ–∑–¥–∞–µ–º –±—ã—Å—Ç—Ä—ã–π –∞–ª–∏–∞—Å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
echo "üìù –°–æ–∑–¥–∞—é –∞–ª–∏–∞—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤..."

if ! grep -q "alias uitest=" ~/.zshrc 2>/dev/null; then
    echo 'alias uitest="cd $(pwd) && ./test-ui.sh"' >> ~/.zshrc
    echo "‚úÖ –ê–ª–∏–∞—Å 'uitest' –¥–æ–±–∞–≤–ª–µ–Ω –≤ ~/.zshrc"
    echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ 'source ~/.zshrc' –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–º—É–ª—è—Ç–æ—Ä
echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ iPhone 16..."
if xcrun simctl list devices | grep -q "iPhone 16"; then
    echo "‚úÖ –°–∏–º—É–ª—è—Ç–æ—Ä iPhone 16 –Ω–∞–π–¥–µ–Ω"
else
    echo "‚ö†Ô∏è  –°–∏–º—É–ª—è—Ç–æ—Ä iPhone 16 –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "   –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ Xcode: Window -> Devices and Simulators"
fi

echo """
üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ UI —Ç–µ—Å—Ç—ã: ./test-ui.sh
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª–∏–∞—Å: uitest (–ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞)
3. –¢–µ—Å—Ç—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- –û—Ç–∫–ª—é—á–∏—Ç—å pre-commit hook: rm ../../.git/hooks/pre-commit
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç: xcodebuild test -scheme LMS -only-testing:LMSUITests/TestClass/testMethod

–£–¥–∞—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è! üöÄ
""" 