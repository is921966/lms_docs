#!/bin/bash

echo "ðŸš€ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð±Ð¸Ð»Ð´Ð° Ð´Ð»Ñ TestFlight..."
echo "==========================================="
echo ""

# ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
NEW_VERSION="2.1.1"
NEW_BUILD="205"
RELEASE_DATE=$(date +"%d.%m.%Y")

echo "ðŸ“± ÐÐ¾Ð²Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ: $NEW_VERSION (Build $NEW_BUILD)"
echo ""

# 1. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ
echo "1ï¸âƒ£ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸..."
agvtool new-marketing-version $NEW_VERSION
agvtool new-version -all $NEW_BUILD

echo "âœ… Ð’ÐµÑ€ÑÐ¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
echo ""

# 2. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ release notes
echo "2ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Release Notes..."

RELEASE_NOTES_FILE="/Users/ishirokov/lms_docs/docs/releases/TESTFLIGHT_RELEASE_v${NEW_VERSION}.md"

cat > "$RELEASE_NOTES_FILE" << EOF
# TestFlight Release v${NEW_VERSION}

**Ð”Ð°Ñ‚Ð° Ñ€ÐµÐ»Ð¸Ð·Ð°**: ${RELEASE_DATE}
**Build**: ${NEW_BUILD}

## ðŸŽ¯ ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ

### âœ… Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð° Ñ‚ÐµÑÑ‚Ð¾Ð²Ð°Ñ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°
- Ð£Ð´Ð°Ð»ÐµÐ½Ñ‹ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ñ‚ÐµÑÑ‚Ð¾Ð²
- Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð²ÑÐµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸ UI Ñ‚ÐµÑÑ‚Ð¾Ð²
- ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð´Ð»Ñ 43 UI Ñ‚ÐµÑÑ‚Ð¾Ð²
- 100% ÑƒÑÐ¿ÐµÑ… Ð²ÑÐµÑ… Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²

### ðŸ”§ Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ
- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ Ð² Ñ‚ÐµÑÑ‚Ð°Ñ…
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ñ€Ð°Ð·Ð½Ñ‹Ñ… UI ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€
- Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð° ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ‚ÐµÑÑ‚Ð¾Ð²
- Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ MockCmi5Service

### ðŸ“± ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸
- Feed UI - ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð° ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
- Cmi5 - Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…
- Course Management - ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð° Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ
- E2E Ñ‚ÐµÑÑ‚Ñ‹ - ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð¿Ð¾Ð»Ð½Ð°Ñ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°

## ðŸ“‹ Ð§Ñ‚Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸ÐºÐ¾Ð²

### ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:
1. **Feed (ÐÐ¾Ð²Ð¾ÑÑ‚Ð¸)**
   - ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ð½Ð¾Ð²Ð¾ÑÑ‚ÐµÐ¹
   - ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ Ð¼ÐµÐ¶Ð´Ñƒ Ð½Ð¾Ð²Ð¾ÑÑ‚ÑÐ¼Ð¸
   - ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð»ÐµÐ½Ñ‚Ñ‹ ÑÐ²Ð°Ð¹Ð¿Ð¾Ð¼ Ð²Ð½Ð¸Ð·

2. **Cmi5 ÐºÑƒÑ€ÑÑ‹**
   - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÐ¿Ð¸ÑÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
   - Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð¾Ð²Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
   - Ð—Ð°Ð¿ÑƒÑÐº Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÐµÐ¹

3. **Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÑƒÑ€ÑÐ°Ð¼Ð¸**
   - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÐºÑƒÑ€ÑÐ°
   - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ ÐºÑƒÑ€ÑÐ°
   - Ð—Ð°Ð¿Ð¸ÑÑŒ Ð½Ð° ÐºÑƒÑ€Ñ

## ðŸ› Ð˜Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹
- ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ UI Ñ‚ÐµÑÑ‚Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ Ð¾ ÑÐ¸Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ðµ (Ð½Ðµ Ð²Ð»Ð¸ÑÐµÑ‚ Ð½Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ)

## ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²
- Ð’ÑÐµÐ³Ð¾ UI Ñ‚ÐµÑÑ‚Ð¾Ð²: 43
- ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾: 20
- Ð£ÑÐ¿ÐµÑˆÐ½Ð¾: 20 (100%)

## ðŸ” Ð¤Ð¾ÐºÑƒÑ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚Ðµ Ð¾ÑÐ¾Ð±Ð¾Ðµ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ Ð½Ð°:
- Ð¡Ñ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ Ð¼Ð¾Ð´ÑƒÐ»ÑÐ¼Ð¸
- ÐšÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Feed
- Ð Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Cmi5 Ð¿Ð°ÐºÐµÑ‚Ð°Ð¼Ð¸
- ÐŸÑ€Ð¾Ñ†ÐµÑÑ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÑƒÑ€ÑÐ°Ð¼Ð¸

---

**Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ**:
- iOS Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ: 17.0
- Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ: iOS 18.5
- Ð Ð°Ð·Ð¼ÐµÑ€ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ: ~45 MB

EOF

echo "âœ… Release Notes ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹: $RELEASE_NOTES_FILE"
echo ""

# 3. ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° DerivedData
echo "3ï¸âƒ£ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° DerivedData..."
rm -rf ~/Library/Developer/Xcode/DerivedData/LMS-*
echo "âœ… DerivedData Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ð°"
echo ""

# 4. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð°
echo "4ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð°..."
echo ""
echo "ðŸ“¦ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ ÑÐ±Ð¾Ñ€ÐºÑƒ Ð°Ñ€Ñ…Ð¸Ð²Ð°..."

xcodebuild archive \
    -scheme LMS \
    -configuration Release \
    -archivePath ~/Desktop/LMS_v${NEW_VERSION}_build${NEW_BUILD}.xcarchive \
    -allowProvisioningUpdates \
    CODE_SIGN_STYLE=Automatic \
    DEVELOPMENT_TEAM=8Y7XSRU6LB

ARCHIVE_RESULT=$?

if [ $ARCHIVE_RESULT -eq 0 ]; then
    echo "âœ… ÐÑ€Ñ…Ð¸Ð² ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!"
    echo "ðŸ“ Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ: ~/Desktop/LMS_v${NEW_VERSION}_build${NEW_BUILD}.xcarchive"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð°Ñ€Ñ…Ð¸Ð²Ð°!"
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ Ð¸ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹"
    exit 1
fi

echo ""
echo "5ï¸âƒ£ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "==================="
echo "1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Xcode Organizer (Window â†’ Organizer)"
echo "2. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð² LMS v${NEW_VERSION} (${NEW_BUILD})"
echo "3. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Distribute App'"
echo "4. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ 'App Store Connect'"
echo "5. Ð¡Ð»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑÐ¼ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð² TestFlight"
echo ""
echo "ðŸ“ Release Notes ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð²:"
echo "   $RELEASE_NOTES_FILE"
echo ""
echo "ðŸŽ‰ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ðº TestFlight Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!" 