//
//  MockFeedService.swift
//  LMS
//
//  Created by LMS Team on 13.01.2025.
//

import Foundation
import Combine

@MainActor
class MockFeedService: ObservableObject {
    
    static let shared = MockFeedService()
    
    @Published var posts: [FeedPost] = []
    @Published var isLoading = false
    @Published var error: FeedError?
    @Published var permissions = FeedPermissions(
        canPost: false,
        canComment: true,
        canLike: true,
        canShare: true,
        canDelete: false,
        canEdit: false,
        canModerate: false,
        visibilityOptions: []
    )
    
    private let authService = MockAuthService.shared
    private var cancellables = Set<AnyCancellable>()
    
    init() {
        setupAuthObserver()
        loadMockData()
        checkAndAddReleaseNews()
    }
    
    private func setupAuthObserver() {
        authService.$currentUser
            .sink { [weak self] user in
                self?.updatePermissions(for: user)
            }
            .store(in: &cancellables)
    }
    
    private func updatePermissions(for user: UserResponse?) {
        guard let user = user else {
            permissions = FeedPermissions(
                canPost: false,
                canComment: true,
                canLike: true,
                canShare: true,
                canDelete: false,
                canEdit: false,
                canModerate: false,
                visibilityOptions: []
            )
            return
        }
        
        switch user.role {
        case .student:
            permissions = FeedPermissions.studentDefault
        case .instructor:
            permissions = FeedPermissions.instructorDefault
        case .admin, .superAdmin:
            permissions = FeedPermissions.adminDefault
        case .manager:
            permissions = FeedPermissions.managerDefault
        }
    }
    
    private func loadMockData() {
        posts = [
            FeedPost(
                id: "1",
                author: UserResponse(
                    id: "admin-1",
                    email: "admin@test.com",
                    name: "Admin User",
                    role: .admin,
                    isActive: true,
                    createdAt: Date()
                ),
                content: "Welcome to our new LMS feed! #announcement",
                images: [],
                attachments: [],
                createdAt: Date().addingTimeInterval(-86400),
                visibility: .everyone,
                likes: ["user1", "user2", "user3"],
                comments: [
                    FeedComment(
                        id: "c1",
                        postId: "1",
                        author: UserResponse(
                            id: "student-1",
                            email: "student@test.com",
                            name: "Student User",
                            role: .student,
                            isActive: true,
                            createdAt: Date()
                        ),
                        content: "Great news!",
                        createdAt: Date().addingTimeInterval(-3600),
                        likes: ["user1"]
                    )
                ],
                tags: ["#announcement"],
                mentions: []
            ),
            FeedPost(
                id: "2",
                author: UserResponse(
                    id: "instructor-1",
                    email: "instructor@test.com",
                    name: "Instructor User",
                    role: .instructor,
                    isActive: true,
                    createdAt: Date()
                ),
                content: "New course materials available for iOS Development! Check them out @students",
                images: ["course_preview.jpg"],
                attachments: [
                    FeedAttachment(
                        id: "a1",
                        type: .course,
                        url: "course://ios-development",
                        name: "iOS Development Course",
                        size: nil,
                        thumbnailUrl: "ios_thumb.jpg"
                    )
                ],
                createdAt: Date().addingTimeInterval(-7200),
                visibility: .students,
                likes: ["user2", "user4"],
                comments: [],
                tags: ["#course", "#ios"],
                mentions: ["students"]
            )
        ]
    }
    
    private func checkAndAddReleaseNews() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –≤ Info.plist
        let hasNewRelease = Bundle.main.infoDictionary?["LMSHasNewRelease"] as? Bool ?? false
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
        let currentVersion = Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? "1.0.0"
        let currentBuild = Bundle.main.infoDictionary?["CFBundleVersion"] as? String ?? "1"
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –Ω–æ–≤–æ—Å—Ç—å –æ —Ä–µ–ª–∏–∑–µ –≤ —Ç–µ–∫—É—â–∏—Ö –ø–æ—Å—Ç–∞—Ö
        let releasePostId = "release-\(currentVersion)-\(currentBuild)"
        let releaseNewsExists = posts.contains { $0.id == releasePostId }
        
        if hasNewRelease && !releaseNewsExists {
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å release notes –∏–∑ bundle
            var releaseContent = ""
            
            if let releaseNotesPath = Bundle.main.path(forResource: "RELEASE_NOTES", ofType: "md"),
               let content = try? String(contentsOfFile: releaseNotesPath) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —Ñ–∞–π–ª–∞
                releaseContent = content
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                releaseContent = """
                üöÄ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è \(currentVersion) (Build \(currentBuild))
                
                ## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                
                ### ‚ú® Sprint 46: Perplexity-Style Redesign
                ‚Ä¢ –°–æ–∑–¥–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Perplexity-—Å—Ç–∏–ª—è
                ‚Ä¢ –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: PerplexityTheme, PerplexitySearchBar, PerplexityCard
                ‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞
                
                ### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è
                ‚Ä¢ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
                ‚Ä¢ –í—Å–µ 43 UI —Ç–µ—Å—Ç–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                ‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö
                
                ## üìã –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–æ–≤
                
                ### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:
                ‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                ‚Ä¢ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤
                ‚Ä¢ –†–∞–±–æ—Ç—É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
                
                ## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
                ‚Ä¢ Perplexity –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–∫–∞ –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                ‚Ä¢ –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ –Ω–∞–¥ –Ω–æ–≤—ã–º –¥–∏–∑–∞–π–Ω–æ–º
                
                #release #update #testflight
                """
            }
            
            let releasePost = FeedPost(
                id: releasePostId,
                author: UserResponse(
                    id: "system",
                    email: "system@lms.com",
                    name: "–ö–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏",
                    role: .admin,
                    isActive: true,
                    createdAt: Date()
                ),
                content: releaseContent,
                images: [],
                attachments: [],
                createdAt: Date(),
                visibility: .everyone,
                likes: [],
                comments: [],
                tags: ["#release", "#update", "#testflight"],
                mentions: []
            )
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –ª–µ–Ω—Ç—ã
            posts.insert(releasePost, at: 0)
        }
    }
    
    // MARK: - Public Methods
    
    func createPost(
        content: String,
        images: [String] = [],
        attachments: [FeedAttachment] = [],
        visibility: FeedVisibility = .everyone
    ) async throws {
        guard let currentUser = authService.currentUser else {
            throw FeedError.noPermission
        }
        
        guard permissions.canPost else {
            throw FeedError.noPermission
        }
        
        let newPost = FeedPost(
            id: UUID().uuidString,
            author: currentUser,
            content: content,
            images: images,
            attachments: attachments,
            createdAt: Date(),
            visibility: visibility,
            likes: [],
            comments: [],
            tags: extractTags(from: content),
            mentions: extractMentions(from: content)
        )
        
        posts.insert(newPost, at: 0)
    }
    
    func deletePost(_ postId: String) async throws {
        guard let post = posts.first(where: { $0.id == postId }) else {
            throw FeedError.postNotFound
        }
        
        let canDelete = post.author.id == authService.currentUser?.id || permissions.canModerate
        
        guard canDelete else {
            throw FeedError.noPermission
        }
        
        posts.removeAll { $0.id == postId }
    }
    
    func toggleLike(postId: String) async throws {
        guard let currentUser = authService.currentUser else {
            throw FeedError.noPermission
        }
        
        guard permissions.canLike else {
            throw FeedError.noPermission
        }
        
        guard let index = posts.firstIndex(where: { $0.id == postId }) else {
            throw FeedError.postNotFound
        }
        
        var post = posts[index]
        
        if post.likes.contains(currentUser.id) {
            post.likes.removeAll { $0 == currentUser.id }
        } else {
            post.likes.append(currentUser.id)
        }
        
        posts[index] = post
    }
    
    func addComment(to postId: String, content: String) async throws {
        guard let currentUser = authService.currentUser else {
            throw FeedError.noPermission
        }
        
        guard permissions.canComment else {
            throw FeedError.noPermission
        }
        
        guard let index = posts.firstIndex(where: { $0.id == postId }) else {
            throw FeedError.postNotFound
        }
        
        let newComment = FeedComment(
            id: UUID().uuidString,
            postId: postId,
            author: currentUser,
            content: content,
            createdAt: Date(),
            likes: []
        )
        
        var post = posts[index]
        post.comments.append(newComment)
        posts[index] = post
    }
    
    func refresh() {
        loadMockData()
        checkAndAddReleaseNews()
    }
    
    // MARK: - Helper Methods
    
    private func extractTags(from content: String) -> [String] {
        let pattern = "#[\\w\\u0400-\\u04FF]+"
        let regex = try? NSRegularExpression(pattern: pattern)
        let matches = regex?.matches(in: content, range: NSRange(content.startIndex..., in: content)) ?? []
        
        return matches.compactMap { match in
            guard let range = Range(match.range, in: content) else { return nil }
            return String(content[range])
        }
    }
    
    private func extractMentions(from content: String) -> [String] {
        let pattern = "@[\\w\\u0400-\\u04FF]+"
        let regex = try? NSRegularExpression(pattern: pattern)
        let matches = regex?.matches(in: content, range: NSRange(content.startIndex..., in: content)) ?? []
        
        return matches.compactMap { match in
            guard let range = Range(match.range, in: content) else { return nil }
            let mention = String(content[range])
            return String(mention.dropFirst()) // Remove @
        }
    }
    
    // MARK: - Test Helpers
    
    func reset() {
        posts.removeAll()
        error = nil
        isLoading = false
        loadMockData()
    }
    
    func setError(_ error: FeedError) {
        self.error = error
    }
    
    func setLoading(_ loading: Bool) {
        self.isLoading = loading
    }
} 