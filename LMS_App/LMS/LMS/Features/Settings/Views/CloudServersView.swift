import SwiftUI
import WebKit

struct CloudServersView: View {
    @State private var selectedServer = 0
    @State private var isLoading = true
    @State private var errorMessage: String?
    @State private var showingShareSheet = false
    @State private var currentURL: URL?
    @State private var showingSettings = false
    @State private var webViewKey = UUID() // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ–º WebView
    
    private var servers: [CloudServer] {
        [
            CloudServer(
                name: "üìä Log Dashboard",
                url: CloudServerManager.shared.logServerURL,
                description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏",
                icon: "doc.text.magnifyingglass",
                color: .blue
            ),
            CloudServer(
                name: "üí¨ Feedback Dashboard",
                url: CloudServerManager.shared.feedbackServerURL,
                description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
                icon: "bubble.left.and.bubble.right.fill",
                color: .green
            )
        ]
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // Server selector
            Picker("Server", selection: $selectedServer) {
                ForEach(servers.indices, id: \.self) { index in
                    Label(servers[index].name, systemImage: servers[index].icon)
                        .tag(index)
                }
            }
            .pickerStyle(SegmentedPickerStyle())
            .padding()
            .onChange(of: selectedServer) { oldValue, newValue in
                ComprehensiveLogger.shared.log(.ui, .info, "Server switched", details: [
                    "from": servers[safe: oldValue]?.name ?? "unknown",
                    "to": servers[safe: newValue]?.name ?? "unknown"
                ])
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª—é—á —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å WebView –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞
                webViewKey = UUID()
                isLoading = true
                errorMessage = nil
            }
            
            // Server info card with health status
            ServerInfoCard(server: servers[selectedServer])
                .padding(.horizontal)
            
            // Web view
            ZStack {
                CloudServerWebView(
                    url: servers[selectedServer].url,
                    isLoading: $isLoading,
                    errorMessage: $errorMessage
                )
                .id(webViewKey) // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
                
                if isLoading {
                    ProgressView("–ó–∞–≥—Ä—É–∑–∫–∞...")
                        .frame(maxWidth: .infinity, maxHeight: .infinity)
                        .background(Color.black.opacity(0.3))
                }
                
                if let error = errorMessage {
                    VStack(spacing: 16) {
                        Image(systemName: "exclamationmark.triangle.fill")
                            .font(.largeTitle)
                            .foregroundColor(.orange)
                        
                        Text("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è")
                            .font(.headline)
                        
                        Text(error)
                            .font(.caption)
                            .foregroundColor(.secondary)
                            .multilineTextAlignment(.center)
                            .padding(.horizontal)
                        
                        VStack(spacing: 8) {
                            Button("–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞") {
                                errorMessage = nil
                                isLoading = true
                            }
                            .buttonStyle(.borderedProminent)
                            
                            Button("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤") {
                                showingSettings = true
                            }
                            .buttonStyle(.bordered)
                        }
                    }
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
                    .background(Color(UIColor.systemBackground))
                }
            }
        }
        .navigationTitle("Cloud Servers")
        .navigationBarTitleDisplayMode(.inline)
        .toolbar {
            ToolbarItem(placement: .navigationBarTrailing) {
                Menu {
                    Button(action: {
                        currentURL = URL(string: servers[selectedServer].url)
                        showingShareSheet = true
                        ComprehensiveLogger.shared.log(.ui, .info, "Share server URL", details: [
                            "server": servers[selectedServer].name
                        ])
                    }) {
                        Label("–ü–æ–¥–µ–ª–∏—Ç—å—Å—è", systemImage: "square.and.arrow.up")
                    }
                    
                    Button(action: {
                        if let url = URL(string: servers[selectedServer].url) {
                            UIApplication.shared.open(url)
                            ComprehensiveLogger.shared.log(.ui, .info, "Open in Safari", details: [
                                "url": url.absoluteString
                            ])
                        }
                    }) {
                        Label("–û—Ç–∫—Ä—ã—Ç—å –≤ Safari", systemImage: "safari")
                    }
                    
                    Button(action: {
                        isLoading = true
                        errorMessage = nil
                        ComprehensiveLogger.shared.log(.ui, .info, "Refresh dashboard", details: [
                            "server": servers[selectedServer].name
                        ])
                    }) {
                        Label("–û–±–Ω–æ–≤–∏—Ç—å", systemImage: "arrow.clockwise")
                    }
                    
                    Divider()
                    
                    Button(action: {
                        showingSettings = true
                        ComprehensiveLogger.shared.log(.ui, .info, "Open server settings")
                    }) {
                        Label("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤", systemImage: "gear")
                    }
                } label: {
                    Image(systemName: "ellipsis.circle")
                }
            }
        }
        .sheet(isPresented: $showingShareSheet) {
            if let url = currentURL {
                CloudServerShareSheet(items: [url])
            }
        }
        .sheet(isPresented: $showingSettings) {
            CloudServerSettingsView()
        }
    }
}

// MARK: - Server Info Card
struct ServerInfoCard: View {
    let server: CloudServer
    @State private var isHealthy = false
    @State private var isChecking = true
    @State private var hasChecked = false // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
    
    var body: some View {
        HStack(spacing: 12) {
            Image(systemName: server.icon)
                .font(.title2)
                .foregroundColor(.white)
                .frame(width: 44, height: 44)
                .background(server.color)
                .cornerRadius(10)
            
            VStack(alignment: .leading, spacing: 4) {
                Text(server.name)
                    .font(.headline)
                
                Text(server.description)
                    .font(.caption)
                    .foregroundColor(.secondary)
                
                Text(server.url)
                    .font(.caption2)
                    .foregroundColor(.blue)
                    .lineLimit(1)
            }
            
            Spacer()
            
            if isChecking {
                ProgressView()
                    .scaleEffect(0.8)
            } else {
                Image(systemName: isHealthy ? "checkmark.circle.fill" : "exclamationmark.circle.fill")
                    .foregroundColor(isHealthy ? .green : .orange)
                    .font(.title3)
            }
        }
        .padding()
        .background(Color(UIColor.secondarySystemBackground))
        .cornerRadius(12)
        .onAppear {
            if !hasChecked {
                checkHealth()
                hasChecked = true
            }
            ComprehensiveLogger.shared.log(.ui, .info, "ServerInfoCard appeared", details: [
                "server": server.name
            ])
        }
    }
    
    private func checkHealth() {
        isChecking = true
        
        CloudServerManager.shared.checkServerHealth { logHealthy, feedbackHealthy in
            DispatchQueue.main.async {
                if server.name.contains("Log") {
                    isHealthy = logHealthy
                } else {
                    isHealthy = feedbackHealthy
                }
                isChecking = false
                
                ComprehensiveLogger.shared.log(.network, .info, "Server health check completed", details: [
                    "server": server.name,
                    "healthy": isHealthy
                ])
            }
        }
    }
}

// MARK: - Settings View
struct CloudServerSettingsView: View {
    @Environment(\.dismiss) var dismiss
    @State private var logServerURL = CloudServerManager.shared.logServerURL
    @State private var feedbackServerURL = CloudServerManager.shared.feedbackServerURL
    @State private var showingResetAlert = false
    
    var body: some View {
        NavigationView {
            Form {
                Section(header: Text("Log Server")) {
                    TextField("URL", text: $logServerURL)
                        .autocapitalization(.none)
                        .disableAutocorrection(true)
                        .textFieldStyle(RoundedBorderTextFieldStyle())
                    
                    Text("Default: https://lms-log-server-production.up.railway.app")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
                
                Section(header: Text("Feedback Server")) {
                    TextField("URL", text: $feedbackServerURL)
                        .autocapitalization(.none)
                        .disableAutocorrection(true)
                        .textFieldStyle(RoundedBorderTextFieldStyle())
                    
                    Text("Default: https://lms-feedback-server-production.up.railway.app")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
                
                Section {
                    Button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è") {
                        CloudServerManager.shared.updateURLs(
                            logServer: logServerURL,
                            feedbackServer: feedbackServerURL
                        )
                        ComprehensiveLogger.shared.log(.ui, .info, "Server URLs updated", details: [
                            "logServer": logServerURL,
                            "feedbackServer": feedbackServerURL
                        ])
                        dismiss()
                    }
                    .frame(maxWidth: .infinity)
                    .foregroundColor(.white)
                    .padding()
                    .background(Color.blue)
                    .cornerRadius(8)
                    
                    Button("–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é") {
                        showingResetAlert = true
                    }
                    .frame(maxWidth: .infinity)
                    .foregroundColor(.red)
                }
            }
            .navigationTitle("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("–û—Ç–º–µ–Ω–∞") {
                        dismiss()
                    }
                }
            }
            .alert("–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?", isPresented: $showingResetAlert) {
                Button("–°–±—Ä–æ—Å–∏—Ç—å", role: .destructive) {
                    CloudServerManager.shared.resetToDefaults()
                    logServerURL = CloudServerManager.shared.logServerURL
                    feedbackServerURL = CloudServerManager.shared.feedbackServerURL
                    ComprehensiveLogger.shared.log(.ui, .warning, "Server URLs reset to defaults")
                }
                Button("–û—Ç–º–µ–Ω–∞", role: .cancel) {}
            } message: {
                Text("URL —Å–µ—Ä–≤–µ—Ä–æ–≤ –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
            }
        }
    }
}

// MARK: - Web View
struct CloudServerWebView: UIViewRepresentable {
    let url: String
    @Binding var isLoading: Bool
    @Binding var errorMessage: String?
    
    class Coordinator: NSObject, WKNavigationDelegate {
        var parent: CloudServerWebView
        var hasLoadedInitialURL = false
        
        init(_ parent: CloudServerWebView) {
            self.parent = parent
        }
        
        func webView(_ webView: WKWebView, didStartProvisionalNavigation navigation: WKNavigation!) {
            parent.isLoading = true
            parent.errorMessage = nil
            ComprehensiveLogger.shared.log(.network, .debug, "WebView started loading", details: [
                "url": webView.url?.absoluteString ?? "unknown"
            ])
        }
        
        func webView(_ webView: WKWebView, didFinish navigation: WKNavigation!) {
            parent.isLoading = false
            hasLoadedInitialURL = true
            ComprehensiveLogger.shared.log(.network, .info, "WebView finished loading", details: [
                "url": webView.url?.absoluteString ?? "unknown"
            ])
        }
        
        func webView(_ webView: WKWebView, didFail navigation: WKNavigation!, withError error: Error) {
            parent.isLoading = false
            parent.errorMessage = error.localizedDescription
            ComprehensiveLogger.shared.log(.network, .error, "WebView failed to load", details: [
                "error": error.localizedDescription
            ])
        }
        
        func webView(_ webView: WKWebView, didFailProvisionalNavigation navigation: WKNavigation!, withError error: Error) {
            parent.isLoading = false
            parent.errorMessage = error.localizedDescription
            ComprehensiveLogger.shared.log(.network, .error, "WebView failed provisional navigation", details: [
                "error": error.localizedDescription
            ])
        }
    }
    
    func makeUIView(context: Context) -> WKWebView {
        let preferences = WKPreferences()
        preferences.javaScriptEnabled = true
        
        let configuration = WKWebViewConfiguration()
        configuration.preferences = preferences
        
        let webView = WKWebView(frame: .zero, configuration: configuration)
        webView.navigationDelegate = context.coordinator
        webView.allowsBackForwardNavigationGestures = true
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        webView.scrollView.contentInsetAdjustmentBehavior = .automatic
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º URL —Å—Ä–∞–∑—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
        if let url = URL(string: url) {
            let request = URLRequest(url: url)
            webView.load(request)
        }
        
        return webView
    }
    
    func updateUIView(_ webView: WKWebView, context: Context) {
        // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞—á–∞–ª—å–Ω—ã–π URL
        guard !context.coordinator.hasLoadedInitialURL else { return }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ URL
        if let currentURL = webView.url?.absoluteString,
           currentURL != url,
           let newURL = URL(string: url) {
            let request = URLRequest(url: newURL)
            webView.load(request)
        }
    }
    
    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }
}

// MARK: - Models
struct CloudServer {
    let name: String
    let url: String
    let description: String
    let icon: String
    let color: Color
}

// MARK: - Share Sheet
struct CloudServerShareSheet: UIViewControllerRepresentable {
    let items: [Any]
    
    func makeUIViewController(context: Context) -> UIActivityViewController {
        UIActivityViewController(activityItems: items, applicationActivities: nil)
    }
    
    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {}
}

// MARK: - Preview
struct CloudServersView_Previews: PreviewProvider {
    static var previews: some View {
        NavigationView {
            CloudServersView()
        }
    }
} 