# Обновление импорта оргструктуры из Excel: Поддержка явной иерархии

## Дата обновления
14 июля 2025

## Проблема
Автоматическое определение иерархии по коду подразделения (например, АП.1.2 → родитель АП.1) может приводить к ошибкам при нестандартной нумерации или ошибках в кодировании.

## Решение
Добавлена обязательная колонка "Вышестоящий Код" для явного указания родительского подразделения.

## Новый формат Excel файла

### Обязательные колонки:
1. **Код** - уникальный код подразделения
2. **Вышестоящий Код** - код родительского подразделения (пустой для корневых)  
3. **Название подразделения** - название подразделения

### Опциональные колонки для сотрудников:
4. **Табельный номер** - табельный номер сотрудника
5. **ФИО** - полное имя сотрудника
6. **Должность** - должность сотрудника
7. **Email** - электронная почта (опционально)
8. **Телефон** - номер телефона (опционально)

## Пример структуры данных

```csv
Код,Вышестоящий Код,Название подразделения,Табельный номер,ФИО,Должность,Email,Телефон
АП,,Аппарат Президента,,,,
АП.1,АП,Управление по работе с персоналом,,,,
АП.1.1,АП.1,Отдел кадров,12345,Иванов И.И.,Начальник отдела,ivanov@company.ru,+7 (495) 123-45-67
АП.1.2,АП.1,Отдел обучения,,,,
АП.2,АП,Финансовое управление,,,,
АП.2.1,АП.2,Бухгалтерия,12348,Козлова М.С.,Главный бухгалтер,kozlova@company.ru,+7 (495) 123-45-70
```

## Логика построения иерархии

1. **Корневые подразделения**: Вышестоящий Код пустой или отсутствует
2. **Дочерние подразделения**: Вышестоящий Код указывает на Код родителя
3. **Порядок обработки**: Автоматическая сортировка для обработки родителей перед детьми

## Преимущества нового подхода

✅ **Явная иерархия** - нет неоднозначности в структуре
✅ **Гибкость кодирования** - можно использовать любые коды
✅ **Исправление ошибок** - легко изменить иерархию без изменения кодов
✅ **Поддержка реорганизаций** - простое перемещение подразделений

## Обратная совместимость

❌ Файлы старого формата (без колонки "Вышестоящий Код") больше не поддерживаются.
✅ При экспорте автоматически добавляется колонка "Вышестоящий Код".

## Технические изменения

### ExcelParser.swift
- Добавлена поддержка колонки "Вышестоящий Код"
- Удалена логика автоматического определения родителя по коду
- Обновлен шаблон Excel файла

### OrgStructureService.swift  
- Обновлена логика построения иерархии
- Использование явного parentCode из Excel
- Автоматический расчет уровней после импорта

## Миграция существующих данных

Для миграции существующих Excel файлов:
1. Экспортируйте текущую структуру через приложение
2. Проверьте правильность колонки "Вышестоящий Код"
3. При необходимости исправьте иерархию
4. Импортируйте обновленный файл 