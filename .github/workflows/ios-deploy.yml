name: Deploy to TestFlight

on:
  push:
    branches: [ main ]
    paths:
      - 'ios/**'
  workflow_dispatch:

env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer

jobs:
  deploy:
    name: Deploy to TestFlight
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        
    - name: Install Fastlane
      run: gem install fastlane
        
    - name: Select Xcode
      run: sudo xcode-select -s $DEVELOPER_DIR
      
    - name: Build and Upload to TestFlight
      working-directory: ./ios/LMS
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
      run: |
        mkdir -p ~/private_keys
        echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8
        fastlane beta
